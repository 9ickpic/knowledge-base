#bitrix 
## Цель кода
Собрать список новостей и для каждой новости -- получить связанные с ней услуги (в данном случае имена и цены) и положить всё в удобную структуру *$arResult\['ITEMS'\]* для вывода на сайт.

## Что важно запомнить (суть логики)
1. Есть два инфоблока: *Новости* (ID = 1) и *Услуги* (ID = 2);
2. Скрипт сначала берёт все элементы из инфоблока *Новости*;
3. Для каждой новости он смотрит свойство *USER_SERVICES* -- там хранятся id услуг;
4. Если id есть -- делает запрос в инфоблок *Услуги*, получает имя и цену каждой услуги;
5. Собирает для каждой новости объект вида:
```php
[
	'NAME' => 'Название новости',
	'SERVICES' => [
		['NAME' => 'Услуга 1', 'PRICE' => '...'],
		['NAME' => 'Услуга 2', 'PRICE' => '...'],
	]
]
```
6. Все такие объекты складываются в массив *$arResult\['ITEMS'\]*;

## Поток данных (коротко)
GetList(Новости) -> перебор GetNextElement() -> GetFields() + GetProperties() -> взять USER_SERVICES -> если есть -> GetList(Услуги, ID = \[..]) -> GetNext() по услугам -> собрать NAME и PROPERTY_PRICE_VALUE -> положить в SERVICES ->записать запись в $arResult\['ITEMS'].

## Шпаргалка

### Назначение: собрать новости с их услугами в $arResult\['ITEMS']

#### Ключевые функции/методы:

- [[CIBlockElement]]::[[GetList]]($sort, $filter, $group, $nav, $select) -- запрос к инфоблоку;

- $res->[[GetNextElement]]() -- возвращает объект элемент (полезен для [[GetFields]]() + [[GetProperties]]());

- $ob->[[GetFields]]() -- поля элемента (ID, NAME, IBLOCK_ID...);

- $ob->[[GetProperties]]() -- свойства элемента (USER_SERVICES и т.п.);

- $resServices->[[GetNext]]() -- возвращает следующую строку результата (включая PROPERTY_\*\_VALUE);

#### Главные параметры:

- *select* -- какие поля запрашиваем (ускоряет запрос);
- filter -- по каким условиям отбираем элементы (важно: IBLOCK_ID, ID);

#### Формат результата:

```php
$arResult['ITEMS'] = [
	['NAME' => ..., 'SERVICES' => [ ['NAME' => ..., 'PRICE' => ...], ... ]],
];
```

#### **Частые накладки / чеклист для отладки:**

- Если `$arResult['ITEMS']` пустой — проверить `IBLOCK_ID` и права доступа.
    
- Если `SERVICES` пустые хотя id есть — проверить формат `USER_SERVICES` (массив или строка), и что фильтр `ID => $serviceIds` получает корректные id.
    
- Если цены пусты — убедиться, что в `GetNext()` свойство приходит как `PROPERTY_PRICE_VALUE`.
    
- Для больших наборов: подумать о производительности (N+1 запрос) — оптимизировать (JOIN-подобные запросы или групповые выборки по списку id).
    
- Для безопасности: проверять и валидировать источники id, права чтения инфоблока.

## Заключение
Этот код берёт новости, смотрит какие услуги прикреплены к каждой новости, достаёт имя и цену этих услуг и собирает компактный массив `$arResult['ITEMS']`, готовый к выводу — главная идея: **двухступенчатый запрос** (сначала новости, затем по нужным id — услуги) и аккуратная сборка результата.


## Минусы этого кода:

-- БД отправляет запросы в каждой итерации цикла по новости. Сколько новостей -- столько БД сделает запросов. Нужно это минимизировать всегда.
-- Верстку сложно читать когда свойств много. Лучше выносить некоторые свойства заранее.